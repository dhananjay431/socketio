<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://maps.google.com/maps/api/js?libraries=geometry,places,drawing"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script>
          var socket = io.connect('http://localhost:3000/chat');
          var msg = [];
        var marker={};

        function getRandomInRange(from, to, fixed) {
            return (Math.random() * (to - from) + from).toFixed(fixed) * 1;
        }
        function liveTrack(map, mark, coords,speed,delay) {
        var target = 0;
        function _goToPoint() {
            // dmap.speed = km_h;
            var lat = mark.position.lat();
            var lng = mark.position.lng();
            var step = (speed * 1000 * delay) / 3600000; // in meters
           
            if(coords[target])
            var dest = new google.maps.LatLng(coords[target].lat, coords[target].lng);
        else
        	return;
            var distance = google.maps.geometry.spherical.computeDistanceBetween(dest, mark.position); // in meters
            var numStep = distance / step;
            var i = 0;
            var deltaLat = (coords[target].lat - lat) / numStep;
            var deltaLng = (coords[target].lng - lng) / numStep;
            function _moveMarker () {
                lat += deltaLat;
                lng += deltaLng;
                i += step;
                if (i < distance) {
                    var head = google.maps.geometry.spherical.computeHeading(mark.getPosition(), new google.maps.LatLng(lat, lng))
                    if ((head != 0) || (head == NaN)) {
                        var dltemp= document.querySelector('img[src="'+mark.dicon+'"]');

                         if(dltemp!= null && dltemp != undefined)
                         {
                            dltemp.style.margin = "5%";
                            dltemp.style.transform = 'rotate('+head+'deg)';
                         }
                            

                    }
                    
                    mark.setPosition(new google.maps.LatLng(lat, lng));
                    mark._moveMarker = setTimeout(_moveMarker,delay);
                }
                else {
                    var head = google.maps.geometry.spherical.computeHeading(mark.getPosition(), new google.maps.LatLng(lat, lng));
                    if ((head != 0) || (head == NaN)) {
                        var dltemp = document.querySelector('img[src="'+mark.dicon+'"]');
                         if(dltemp!= null && dltemp != undefined){
                            dltemp.style.transform = 'rotate('+head+'deg)';
                         }
                        
                    }
                    // mark.setIcon(icons);
                    mark.setPosition(dest);
                    target++;
                 mark._goToPoint = setTimeout(_goToPoint,delay);
                }
            }
            _moveMarker();
        }
        _goToPoint();
    }

        $(function(){
            map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 18.62816, lng: 73.85206000000001},
            zoom: 3
            });
//////////////
for(var i=0;i<100;i++){
            msg.push(Math.floor(Math.random() * 100000) + 1)
          }
          for(var i in msg){
            socket.emit('get',msg[i])      
            socket.on(msg[i]+'get', function (data) {
               if(marker[data.key]){
                //marker[data.key].setPosition(data);
                if(marker[data.key]._moveMarker)
        clearTimeout(marker[data.key]._moveMarker);
        if(marker[data.key]._goToPoint)
        clearTimeout(marker[data.key]._goToPoint);

                    if(data.lat  && data.lng)
                    liveTrack(map, marker[data.key], [data],50000,10);
                

               }else{
                console.log("else=",marker[data.key]);
                var icon = `/static/plain32X32.png?id=${data.key}`;   
                var _marker = new google.maps.Marker({
                    position: data,	
                    map: map,
                    title: `${data.key}`,
                    icon:icon
                });	
                _marker.dicon=icon;
                 marker[data.key]=   _marker;
               }
               
            });
          }

            setInterval(function(){
                for(var i in msg){
                    (function(key){
                        var latLng={};
                        latLng.lat = getRandomInRange(180,-180,3);
                        latLng.lng = getRandomInRange(180,-180,3);
                        latLng.key=key;
                        socket.emit('sendData',key,latLng);     
                    })(msg[i]) 
            }
            },Math.floor(Math.random() * 10000) + 1000);



        });
      </script>
    <title>Hello, world!</title>

    
  </head>
  <body>
        <div id="map" style="width:100%;height:700px;"></div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script> -->
  </body>
</html>


